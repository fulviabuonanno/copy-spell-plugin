<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    @import url('https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700&display=swap');

    body {
      font-family: 'Instrument Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 12px;
      padding: 16px;
      background:
        linear-gradient(to bottom, rgba(255, 255, 255, 0.75), rgba(255, 255, 255, 0.85)),
        center / contain no-repeat url('background.png'),
        linear-gradient(135deg, #fff5f0 0%, #ffe8e8 100%);
      color: #333;
      min-height: 100vh;
    }

    .header {
      margin-bottom: 16px;
    }

    .header h2 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .header p {
      font-size: 11px;
      color: #999;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }

    .empty-state svg {
      width: 48px;
      height: 48px;
      margin-bottom: 12px;
      opacity: 0.3;
    }

    .colors-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .color-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .color-item:hover {
      border-color: #0066ff;
      background: #f7f9fc;
    }

    .color-swatch {
      width: 32px;
      height: 32px;
      border-radius: 4px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      flex-shrink: 0;
    }

    .color-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .color-hex {
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 13px;
      font-weight: 500;
    }

    .color-name {
      font-size: 11px;
      color: #666;
      display: flex;
      align-items: flex-start;
      gap: 4px;
      word-break: break-word;
      overflow-wrap: break-word;
      flex-wrap: wrap;
    }

    .color-name span:last-child {
      flex: 1;
      word-break: break-word;
      min-width: 0;
    }

    .color-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 9px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .color-badge.variable {
      background: #e3f2fd;
      color: #1976d2;
    }

    .color-badge.style {
      background: #f3e5f5;
      color: #7b1fa2;
    }

    .copy-icon {
      width: 16px;
      height: 16px;
      opacity: 0.5;
      flex-shrink: 0;
    }

    .color-item:hover .copy-icon {
      opacity: 1;
    }

    .copy-all-btn {
      width: 100%;
      padding: 10px;
      margin-top: 16px;
      background: #0066ff;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .copy-all-btn:hover {
      background: #0052cc;
    }

    .copy-all-btn:active {
      background: #003d99;
    }

    .copy-all-btn:disabled {
      background: #e0e0e0;
      color: #999;
      cursor: not-allowed;
    }

    .copied-feedback {
      position: fixed;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: #000;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 11px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }

    .copied-feedback.show {
      opacity: 0.9;
    }

    .footer {
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid #e0e0e0;
      text-align: center;
      font-size: 10px;
      color: #999;
    }
  </style>
</head>
<body>
  <div class="header">
    <h2>✨ Copy Spell</h2>
    <p id="selection-info">Select an element to reveal its color essence</p>
  </div>

  <div id="empty-state" class="empty-state">
    <svg viewBox="0 0 24 24" fill="currentColor">
      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5.5-2.5l7.51-3.49L17.5 6.5 9.99 9.99 6.5 17.5zm5.5-6.6c.61 0 1.1.49 1.1 1.1s-.49 1.1-1.1 1.1-1.1-.49-1.1-1.1.49-1.1 1.1-1.1z"/>
    </svg>
    <p>Cast your spell upon elements with fill colors</p>
  </div>

  <div id="colors-container" style="display: none;">
    <div class="colors-list" id="colors-list"></div>
    <button class="copy-all-btn" id="copy-all-btn">⚡ Capture All Essences</button>
  </div>

  <div class="copied-feedback" id="copied-feedback">Essence captured!</div>

  <div class="footer">
    made with ✨ in Barcelona
  </div>

  <script>
    let currentColors = [];

    // Handle messages from plugin code
    onmessage = (event) => {
      const msg = event.data.pluginMessage;

      if (msg.type === 'colors-updated') {
        currentColors = msg.colors;
        updateUI(msg.colors, msg.selectionCount);
      }
    };

    function updateUI(colors, selectionCount) {
      const emptyState = document.getElementById('empty-state');
      const container = document.getElementById('colors-container');
      const selectionInfo = document.getElementById('selection-info');
      const colorsList = document.getElementById('colors-list');

      if (colors.length === 0) {
        emptyState.style.display = 'block';
        container.style.display = 'none';
        selectionInfo.textContent = selectionCount === 0
          ? 'Select an element to reveal its color essence'
          : `${selectionCount} element(s) selected - no color essences detected`;
      } else {
        emptyState.style.display = 'none';
        container.style.display = 'block';
        selectionInfo.textContent = `${colors.length} essence(s) discovered in ${selectionCount} element(s)`;

        // Clear and rebuild colors list
        colorsList.innerHTML = '';
        colors.forEach(color => {
          const item = createColorItem(color);
          colorsList.appendChild(item);
        });
      }
    }

    function createColorItem(colorData) {
      const item = document.createElement('div');
      item.className = 'color-item';

      const textToCopy = colorData.name ? `${colorData.hex}, ${colorData.name}` : colorData.hex;
      item.onclick = () => copyColor(textToCopy, colorData.hex);

      const swatch = document.createElement('div');
      swatch.className = 'color-swatch';
      swatch.style.background = colorData.hex;

      const colorInfo = document.createElement('div');
      colorInfo.className = 'color-info';

      const hexText = document.createElement('div');
      hexText.className = 'color-hex';
      hexText.textContent = colorData.hex;

      colorInfo.appendChild(hexText);

      // Add name and badge if available
      if (colorData.name) {
        const nameContainer = document.createElement('div');
        nameContainer.className = 'color-name';

        if (colorData.type) {
          const badge = document.createElement('span');
          badge.className = `color-badge ${colorData.type}`;
          badge.textContent = colorData.type;
          nameContainer.appendChild(badge);
        }

        const nameText = document.createElement('span');
        nameText.textContent = colorData.name;
        nameContainer.appendChild(nameText);

        colorInfo.appendChild(nameContainer);
      }

      const icon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      icon.setAttribute('class', 'copy-icon');
      icon.setAttribute('viewBox', '0 0 16 16');
      icon.setAttribute('fill', 'currentColor');
      icon.innerHTML = '<path d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6zM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1H2z"/>';

      item.appendChild(swatch);
      item.appendChild(colorInfo);
      item.appendChild(icon);

      return item;
    }

    function copyColor(text, displayText) {
      copyToClipboard(text)
        .then(() => {
          showCopiedFeedback(displayText || text);
          parent.postMessage({ pluginMessage: { type: 'copy-color', color: displayText || text } }, '*');
        })
        .catch((err) => {
          console.error('Failed to copy:', err);
          parent.postMessage({ pluginMessage: { type: 'copy-error', error: err.message } }, '*');
        });
    }

    function copyAllColors() {
      if (currentColors.length === 0) return;

      const text = currentColors.map(c =>
        c.name ? `${c.hex}, ${c.name}` : c.hex
      ).join('\n');

      copyToClipboard(text)
        .then(() => {
          showCopiedFeedback(`${currentColors.length} essences`);
          parent.postMessage({
            pluginMessage: { type: 'copy-all', count: currentColors.length }
          }, '*');
        })
        .catch((err) => {
          console.error('Failed to copy:', err);
          parent.postMessage({ pluginMessage: { type: 'copy-error', error: err.message } }, '*');
        });
    }

    function copyToClipboard(text) {
      // Try multiple methods to ensure compatibility
      if (navigator.clipboard && navigator.clipboard.writeText) {
        return navigator.clipboard.writeText(text);
      } else {
        // Fallback method using textarea
        return new Promise((resolve, reject) => {
          const textarea = document.createElement('textarea');
          textarea.value = text;
          textarea.style.position = 'fixed';
          textarea.style.opacity = '0';
          document.body.appendChild(textarea);
          textarea.focus();
          textarea.select();

          try {
            const successful = document.execCommand('copy');
            document.body.removeChild(textarea);
            if (successful) {
              resolve();
            } else {
              reject(new Error('Copy command failed'));
            }
          } catch (err) {
            document.body.removeChild(textarea);
            reject(err);
          }
        });
      }
    }

    function showCopiedFeedback(text) {
      const feedback = document.getElementById('copied-feedback');
      feedback.textContent = `✨ Captured ${text}!`;
      feedback.classList.add('show');
      setTimeout(() => {
        feedback.classList.remove('show');
      }, 2000);
    }

    // Setup copy all button
    document.getElementById('copy-all-btn').onclick = copyAllColors;

    // Request initial colors
    parent.postMessage({ pluginMessage: { type: 'get-colors' } }, '*');
  </script>
</body>
</html>
